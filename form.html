<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age Verification Form</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="form-container">
        <div class="progress-container">
            <div>
                <div class="progress-step">1</div>
                <div>Information</div>
            </div>
            <div>
                <div id="livenessStep" class="progress-step inactive">2</div>
                <div>Liveness</div>
            </div>
            <div>
                <div class="progress-step inactive">3</div>
                <div>Complete</div>
            </div>
        </div>
        <div id="formSection">
            <form id="verificationForm">
                <div class="form-group">
                    <label for="captureMethod">Choose Capture Method</label>
                    <select id="captureMethod" name="captureMethod" required>
                        <option value="personal">Personal Information</option>
                        <option value="qr">QR Code</option>
                    </select>
                </div>
                <div id="personalInfo">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="middleName">Middle Name (Optional)</label>
                        <input type="text" id="middleName" name="middleName">
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="suffix">Suffix</label>
                        <input type="text" id="suffix" name="suffix">
                    </div>
                    <div class="form-group">
                        <label for="birthDate">Birth Date</label>
                        <input type="text" id="birthDate" name="birthDate" required>
                    </div>
                    <input type="hidden" id="faceLivenessSessionId" name="faceLivenessSessionId">
                </div>
                <div id="qrSection" style="display: none;">
                    <div id="reader"></div>
                    <input type="hidden" id="qrCodeValue" name="qrCodeValue" required>
                </div>
                <div class="form-group">
                    <button type="submit">NEXT</button>
                </div>
            </form>            
        </div>
        <div id="responseContainer" style="display: none;">
            <h2>PSA Verification Result</h2>
            <div id="response"></div>
            <div id="tiers">
                <div><strong>TIER 1:</strong> <span id="tier1"></span></div>
                <div><strong>TIER 2:</strong> <span id="tier2"></span></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://liveness.everify.gov.ph/js/everify-liveness-sdk.min.js"></script>
    <script>
        flatpickr("#birthDate", {
            dateFormat: "Y-m-d",
            maxDate: "today",
            defaultDate: "2000-01-01"
        });

        document.getElementById('captureMethod').addEventListener('change', function() {
            const personalInfo = document.getElementById('personalInfo');
            const qrSection = document.getElementById('qrSection');
            if (this.value === 'qr') {
                personalInfo.style.display = 'none';
                qrSection.style.display = 'block';
                startQrReader();
            } else {
                personalInfo.style.display = 'block';
                qrSection.style.display = 'none';
                stopQrReader();
            }
        });

                    document.getElementById('verificationForm').addEventListener('submit', function(event) {
                event.preventDefault();
                if (validateForm()) {
                    startLiveness();
                }
            });

            function validateForm() {
                const captureMethod = document.getElementById('captureMethod').value;
                let isValid = true;
                if (captureMethod === 'personal') {
                    const requiredFields = ['firstName', 'lastName', 'birthDate'];
                    requiredFields.forEach(field => {
                        if (!document.getElementById(field).value) {
                            isValid = false;
                            alert(`${field} is required`);
                        }
                    });
                } else if (captureMethod === 'qr') {
                    if (!document.getElementById('qrCodeValue').value) {
                        isValid = false;
                        alert('QR Code is required');
                    }
                }
                return isValid;
            }

                function startLiveness() {
                        window.eKYC().start({
                            pubKey: 'eyJpdiI6IjNMdno2WCtTYkppRjhWVEM3d0tkd3c9PSIsInZhbHVlIjoiSXN0bFZtM1BxT2F1WmZXUjF2ZkcwUT09IiwibWFjIjoiYmRkMThkZmZkYjI0ODEyNzAxZmM0MGNjOWE2ZDQ3MTJhNTNmZjk5OGIyNjYwMDE4YTIzZTIyMTM0NTMxMGI0MCIsInRhZyI6IiJ9'
                        }).then((data) => {
                            console.log('Liveness response data:', data);
                            showLivenessResult(data);

                            // Check the structure of the response data
                            console.log('Response keys:', Object.keys(data));
                            console.log('Response values:', Object.values(data));
                            console.log('Session ID:', data.session_id);

                            // Extract session_id correctly from nested data
                            const sessionId = data.session_id || (data.result && data.result.session_id);
                            if (sessionId) {
                                submitTier1(sessionId);
                            } else {
                                console.error('Liveness session ID not found in response');
                                alert('Liveness session ID not found. Please try again.');
                            }
                        }).catch((err) => {
                            console.log('error', err);
                            showLivenessResult({ success: false, error: err.message });
                        });
                    }





        function showLivenessResult(data) {
            const responseContainer = document.getElementById('responseContainer');
            const response = document.getElementById('response');
            const formSection = document.getElementById('formSection');
            
            // Hide form section and show response container
            formSection.style.display = 'none';
            responseContainer.style.display = 'block';
            
            // Update response text
            response.textContent = data.success ? 'Verification successful!' : `Verification failed: ${data.error}`;
            
            // Update progress step to Liveness
            const livenessStep = document.getElementById('livenessStep');
            livenessStep.classList.remove('inactive');
        }



                function submitTier1(sessionId) {
                    const captureMethod = document.getElementById('captureMethod').value;
                    let url, data;

                    if (captureMethod === 'personal') {
                        const formData = new FormData(document.getElementById('verificationForm'));
                        data = {
                            first_name: formData.get('firstName'),
                            middle_name: formData.get('middleName'),
                            last_name: formData.get('lastName'),
                            face_liveness_session_id: sessionId,
                            birth_date: formData.get('birthDate')
                        };
                        url = 'https://ws.everify.gov.ph/api/dev/query';
                    } else {
                        data = {
                            value: document.getElementById('qrCodeValue').value,
                            face_liveness_session_id: sessionId
                        };
                        url = 'https://ws.everify.gov.ph/api/dev/query/qr';
                    }

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': 'Bearer TIER 1 TOKEN',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Tier 1 Success:', data);
                        document.getElementById('tier1').textContent = JSON.stringify(data, undefined, 2);
                        submitTier2(data, sessionId);
                    })
                    .catch(error => {
                        console.error('Tier 1 Error:', error);
                        alert('Tier 1 verification failed. Please try again.');
                    });
                }


                function submitTier2(tier1Data, sessionId) {
                    const captureMethod = document.getElementById('captureMethod').value;
                    let data, url = 'https://ws.everify.gov.ph/api/dev/query/qr';

                    if (captureMethod === 'personal') {
                        data = {
                            tier1Response: tier1Data,
                            face_liveness_session_id: sessionId
                        };
                    } else {
                        data = {
                            value: document.getElementById('qrCodeValue').value,
                            tier1Response: tier1Data,
                            face_liveness_session_id: sessionId
                        };
                    }

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': 'Bearer TIER 2 TOKEN',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Tier 2 Success:', data);
                        document.getElementById('tier2').textContent = JSON.stringify(data, undefined, 2);
                        alert('Verification successful!');
                        const completeStep = document.querySelectorAll('.progress-step')[2];
                        completeStep.classList.remove('inactive');
                    })
                    .catch(error => {
                        console.error('Tier 2 Error:', error);
                        alert('Tier 2 verification failed. Please try again.');
                    });
                }



        let qrReader;

        function startQrReader() {
            qrReader = new Html5Qrcode("qr-reader");
            qrReader.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 },
                (qrCodeMessage) => {
                    document.getElementById('qrCodeValue').value = qrCodeMessage;
                    alert('QR Code detected: ' + qrCodeMessage);
                    qrReader.stop();
                },
                (errorMessage) => {
                    console.log('QR Code no longer in front of camera.');
                }
            ).catch((err) => {
                console.log('Unable to start QR code scanning: ' + err);
            });
        }

        function stopQrReader() {
            if (qrReader) {
                qrReader.stop().catch((err) => {
                    console.log('Unable to stop QR code scanning: ' + err);
                });
            }
        }
    </script>
</body>
</html>
